<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise de Dependências - Project Forecaster</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4A90E2;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .card {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #357ABD 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 20px;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: var(--primary-color);
        }

        .dependency-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .dependency-card.critical {
            border-left-color: var(--danger-color);
        }

        .dependency-card.high {
            border-left-color: #fd7e14;
        }

        .dependency-card.medium {
            border-left-color: var(--warning-color);
        }

        .dependency-card.low {
            border-left-color: var(--success-color);
        }

        .metric-box {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
            margin-bottom: 20px;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .metric-label {
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .metric-box.risk-critical .metric-value {
            color: var(--danger-color);
        }

        .metric-box.risk-high .metric-value {
            color: #fd7e14;
        }

        .metric-box.risk-medium .metric-value {
            color: var(--warning-color);
        }

        .metric-box.risk-low .metric-value {
            color: var(--success-color);
        }

        .result-card {
            border-left: 4px solid var(--primary-color);
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
        }

        .spinner-container {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .insight-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .btn-add-dependency {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
        }

        .btn-add-dependency:hover {
            background: #218838;
            color: white;
        }

        .probability-slider {
            width: 100%;
        }

        .critical-path-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid var(--danger-color);
        }

        .recommendation-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid var(--primary-color);
        }

        .form-label {
            font-weight: 600;
            color: #495057;
        }

        .required-field {
            color: var(--danger-color);
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header Card -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="mb-0">
                            <i class="fas fa-project-diagram"></i> Análise de Impacto de Dependências
                        </h1>
                        <p class="mb-0 mt-2">Entenda como dependências entre projetos afetam suas chances de entrega no prazo</p>
                    </div>
                    <div>
                        <a href="/" class="btn btn-light me-2">
                            <i class="fas fa-home"></i> Voltar
                        </a>
                        <a href="/forecast-vs-actual" class="btn btn-light">
                            <i class="fas fa-balance-scale"></i> Forecast vs Actual
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Key Insight -->
        <div class="insight-box">
            <h4><i class="fas fa-lightbulb"></i> Insight Chave: O Problema 2^n</h4>
            <p class="mb-2">
                Para cada dependência, existe uma chance de atraso. Com <strong>n dependências</strong>,
                a probabilidade de todas serem entregues no prazo é de <strong>1 em 2^n</strong>.
            </p>
            <p class="mb-3">
                <strong><i class="fas fa-exclamation-triangle"></i> Cada dependência removida DOBRA suas chances de sucesso!</strong>
            </p>
            <div class="row text-center">
                <div class="col-md-4">
                    <strong>1 dependência</strong><br>50% chance (1/2)
                </div>
                <div class="col-md-4">
                    <strong>3 dependências</strong><br>12.5% chance (1/8)
                </div>
                <div class="col-md-4">
                    <strong>7 dependências</strong><br>0.78% chance (1/128)
                </div>
            </div>
        </div>

        <!-- Input Form -->
        <div class="card">
            <div class="card-header">
                <h3 class="mb-0"><i class="fas fa-plus-circle"></i> Configurar Dependências</h3>
            </div>
            <div class="card-body">
                <div id="dependencies-container">
                    <!-- Dependencies will be added here -->
                </div>

                <button class="btn btn-add-dependency w-100 mb-4" onclick="addDependency()">
                    <i class="fas fa-plus"></i> Adicionar Dependência
                </button>

                <hr>

                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">
                            <i class="fas fa-dice"></i> Número de Simulações Monte Carlo:
                        </label>
                        <input type="number" class="form-control" id="numSimulations"
                               value="10000" min="1000" max="100000" step="1000">
                        <small class="text-muted">Mais simulações = maior precisão (mas mais lento)</small>
                    </div>
                </div>

                <button class="btn btn-primary btn-lg w-100 mt-4" onclick="runAnalysis()">
                    <i class="fas fa-chart-bar"></i> Executar Análise
                </button>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div class="spinner-container" id="loadingSpinner">
            <div class="spinner-border text-light" style="width: 4rem; height: 4rem;" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <h4 class="text-white mt-3">Analisando dependências...</h4>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" style="display: none;">
            <!-- Key Metrics -->
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0"><i class="fas fa-chart-pie"></i> Resultados da Análise</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="metric-box" id="onTimeMetric">
                                <div class="metric-value" id="onTimeValue">--</div>
                                <div class="metric-label">Probabilidade de Entrega no Prazo</div>
                                <small class="text-muted" id="oddsRatio">--</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-box" id="riskMetric">
                                <div class="metric-value" id="riskValue">--</div>
                                <div class="metric-label">Nível de Risco</div>
                                <small class="text-muted" id="riskScore">--</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-box">
                                <div class="metric-value text-warning" id="delayValue">--</div>
                                <div class="metric-label">Atraso Esperado (dias)</div>
                                <small class="text-muted">Se houver atraso</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-box">
                                <div class="metric-value text-danger" id="delayedProbValue">--</div>
                                <div class="metric-label">Prob. de Atraso</div>
                                <small class="text-muted">Pelo menos uma</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Visualization -->
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0"><i class="fas fa-chart-area"></i> Visualização de Impacto</h3>
                </div>
                <div class="card-body">
                    <img id="visualizationImage" src="" alt="Análise de Dependências" class="img-fluid rounded">
                </div>
            </div>

            <!-- Critical Path and Recommendations -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Caminho Crítico</h4>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">As dependências mais críticas (maior impacto):</p>
                            <div id="criticalPathList"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="mb-0"><i class="fas fa-lightbulb"></i> Recomendações</h4>
                        </div>
                        <div class="card-body">
                            <div id="recommendationsList"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Delay Percentiles -->
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0"><i class="fas fa-chart-line"></i> Distribuição de Atrasos</h4>
                </div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Percentil</th>
                                <th>Atraso (dias)</th>
                            </tr>
                        </thead>
                        <tbody id="percentilesTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let dependencyCount = 0;

        // Add initial dependencies with examples on page load
        document.addEventListener('DOMContentLoaded', function() {
            addDependencyWithExample('API Service', 'Mobile App', 'Backend Team', 60, 10, 'HIGH');
            addDependencyWithExample('Database Schema', 'Mobile App', 'DBA Team', 70, 5, 'MEDIUM');
        });

        function addDependencyWithExample(name = '', source = '', target = '', prob = 50, delay = 10, crit = 'MEDIUM') {
            dependencyCount++;
            const container = document.getElementById('dependencies-container');

            const depCard = document.createElement('div');
            depCard.className = 'dependency-card ' + crit.toLowerCase();
            depCard.id = `dep-${dependencyCount}`;
            depCard.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="fas fa-link"></i> Dependência ${dependencyCount}</h5>
                    <button class="btn btn-sm btn-danger" onclick="removeDependency(${dependencyCount})">
                        <i class="fas fa-trash"></i> Remover
                    </button>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">ID:</label>
                            <input type="text" class="form-control dep-id" value="DEP-${dependencyCount}">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Nome: <span class="required-field">*</span></label>
                            <input type="text" class="form-control dep-name" placeholder="Ex: API Authentication" value="${name}">
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Projeto Fonte (bloqueado): <span class="required-field">*</span></label>
                            <input type="text" class="form-control dep-source" placeholder="Ex: Mobile App" value="${source}">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Projeto Alvo (bloqueador): <span class="required-field">*</span></label>
                            <input type="text" class="form-control dep-target" placeholder="Ex: Backend Team" value="${target}">
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Probabilidade de Entrega no Prazo:</label>
                            <input type="range" class="form-range probability-slider dep-probability"
                                   min="0" max="100" value="${prob}" step="5"
                                   oninput="updateProbabilityLabel(this)">
                            <div class="text-center mt-1">
                                <strong class="prob-label">${prob}%</strong>
                            </div>
                            <small class="text-muted">Use dados históricos</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Impacto de Atraso (dias):</label>
                            <input type="number" class="form-control dep-delay" value="${delay}" min="0" step="1">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Criticidade:</label>
                            <select class="form-select dep-criticality" onchange="updateCardColor(this)">
                                <option value="LOW" ${crit === 'LOW' ? 'selected' : ''}>Baixa</option>
                                <option value="MEDIUM" ${crit === 'MEDIUM' ? 'selected' : ''}>Média</option>
                                <option value="HIGH" ${crit === 'HIGH' ? 'selected' : ''}>Alta</option>
                                <option value="CRITICAL" ${crit === 'CRITICAL' ? 'selected' : ''}>Crítica</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;

            container.appendChild(depCard);
        }

        function addDependency() {
            addDependencyWithExample('', '', '', 50, 10, 'MEDIUM');
        }

        function removeDependency(id) {
            const dep = document.getElementById(`dep-${id}`);
            if (dep) {
                dep.remove();
            }
        }

        function updateProbabilityLabel(slider) {
            const label = slider.parentElement.querySelector('.prob-label');
            label.textContent = slider.value + '%';
        }

        function updateCardColor(select) {
            const card = select.closest('.dependency-card');
            card.classList.remove('critical', 'high', 'medium', 'low');
            card.classList.add(select.value.toLowerCase());
        }

        function collectDependencies() {
            const dependencies = [];
            const cards = document.querySelectorAll('.dependency-card');
            const errors = [];

            cards.forEach((card, index) => {
                const name = card.querySelector('.dep-name').value.trim();
                const source = card.querySelector('.dep-source').value.trim();
                const target = card.querySelector('.dep-target').value.trim();

                const hasAnyData = name || source || target;

                if (hasAnyData) {
                    if (!name) errors.push(`Dependência ${index + 1}: Campo "Nome" é obrigatório`);
                    if (!source) errors.push(`Dependência ${index + 1}: Campo "Projeto Fonte" é obrigatório`);
                    if (!target) errors.push(`Dependência ${index + 1}: Campo "Projeto Alvo" é obrigatório`);

                    if (name && source && target) {
                        const dep = {
                            id: card.querySelector('.dep-id').value,
                            name: name,
                            source_project: source,
                            target_project: target,
                            on_time_probability: parseFloat(card.querySelector('.dep-probability').value) / 100,
                            delay_impact_days: parseFloat(card.querySelector('.dep-delay').value),
                            criticality: card.querySelector('.dep-criticality').value
                        };
                        dependencies.push(dep);
                    }
                }
            });

            return { dependencies, errors };
        }

        async function runAnalysis() {
            const result = collectDependencies();

            if (result.errors.length > 0) {
                alert('Erros de validação:\n\n' + result.errors.join('\n'));
                return;
            }

            if (result.dependencies.length === 0) {
                alert('Por favor, preencha os campos de pelo menos uma dependência!\n\n' +
                      'Campos obrigatórios:\n' +
                      '• Nome da dependência\n' +
                      '• Projeto Fonte (bloqueado)\n' +
                      '• Projeto Alvo (bloqueador)');
                return;
            }

            const dependencies = result.dependencies;

            // Show loading
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';

            const payload = {
                dependencies: dependencies,
                num_simulations: parseInt(document.getElementById('numSimulations').value)
            };

            try {
                const response = await fetch('/api/dependency-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error('Erro na análise: ' + response.statusText);
                }

                const resultData = await response.json();
                displayResults(resultData);

            } catch (error) {
                alert('Erro ao executar análise: ' + error.message);
                console.error(error);
            } finally {
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }

        function displayResults(result) {
            document.getElementById('resultsSection').style.display = 'block';

            // Update key metrics
            document.getElementById('onTimeValue').textContent = result.on_time_probability_percentage.toFixed(1) + '%';
            document.getElementById('oddsRatio').textContent = result.odds_ratio;
            document.getElementById('riskValue').textContent = result.risk_level;
            document.getElementById('riskScore').textContent = 'Score: ' + result.risk_score.toFixed(0) + '/100';
            document.getElementById('delayValue').textContent = result.expected_delay_days.toFixed(1);
            document.getElementById('delayedProbValue').textContent = result.at_least_one_delayed_probability_percentage.toFixed(1) + '%';

            // Update metric box colors
            const riskMetric = document.getElementById('riskMetric');
            riskMetric.className = 'metric-box risk-' + result.risk_level.toLowerCase();

            const onTimeMetric = document.getElementById('onTimeMetric');
            onTimeMetric.className = 'metric-box';
            if (result.on_time_probability_percentage < 10) {
                onTimeMetric.classList.add('risk-critical');
            } else if (result.on_time_probability_percentage < 30) {
                onTimeMetric.classList.add('risk-high');
            } else if (result.on_time_probability_percentage < 60) {
                onTimeMetric.classList.add('risk-medium');
            } else {
                onTimeMetric.classList.add('risk-low');
            }

            // Generate visualization
            generateVisualization(result);

            // Critical path
            const criticalPathList = document.getElementById('criticalPathList');
            criticalPathList.innerHTML = '';
            result.critical_path.forEach((dep, index) => {
                criticalPathList.innerHTML += `
                    <div class="critical-path-item">
                        <strong>${index + 1}.</strong> ${dep}
                    </div>
                `;
            });

            // Recommendations
            const recList = document.getElementById('recommendationsList');
            recList.innerHTML = '';
            result.recommendations.forEach(rec => {
                recList.innerHTML += `
                    <div class="recommendation-card">
                        ${rec}
                    </div>
                `;
            });

            // Percentiles
            const percTable = document.getElementById('percentilesTable');
            percTable.innerHTML = '';
            Object.entries(result.delay_percentiles).forEach(([p, value]) => {
                percTable.innerHTML += `
                    <tr>
                        <td><strong>${p.toUpperCase()}</strong></td>
                        <td>${value.toFixed(1)} dias</td>
                    </tr>
                `;
            });

            // Scroll to results
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        async function generateVisualization(result) {
            try {
                const response = await fetch('/api/visualize-dependencies', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(result)
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('visualizationImage').src = data.image;
                }
            } catch (error) {
                console.error('Error generating visualization:', error);
            }
        }
    </script>
</body>
</html>
