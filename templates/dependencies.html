{% extends "base.html" %}
{% block title %}Dependências · Flow Forecaster{% endblock %}
{% block page_title %}Gestão de Dependências{% endblock %}
{% block page_subtitle %}Simule o impacto de dependências e priorize mitigação com base no cenário mais recente.{% endblock %}
{% block header_actions %}
<a href="{{ url_for('simulation') }}" class="btn btn-outline-modern"><i class="fas fa-arrow-left mr-2"></i>Voltar para simulação</a>
{% endblock %}
{% block content %}
<div class="card-modern mb-4">
    <div class="d-flex align-items-center justify-content-between flex-wrap">
        <div>
            <h4 class="mb-2">Cadastro de dependências</h4>
            <p class="text-muted mb-3">Liste bloqueios externos para incluí-los na próxima simulação Monte Carlo.</p>
        </div>
        <div class="btn-group btn-group-sm" role="group">
            <button type="button" class="btn btn-outline-modern" id="dependencyAddButton"><i class="fas fa-plus mr-2"></i>Adicionar dependência</button>
            <button type="button" class="btn btn-outline-modern" id="saveDependencies"><i class="fas fa-save mr-2"></i>Salvar</button>
            <button type="button" class="btn btn-outline-modern" id="loadDependencies"><i class="fas fa-rotate mr-2"></i>Carregar salvas</button>
        </div>
    </div>
    <div class="table-responsive table-modern">
        <table class="table table-sm" id="dependencies">
            <thead>
                <tr class="text-uppercase text-muted">
                    <th class="col-3">Dependência</th>
                    <th class="col-3">Projeto fonte</th>
                    <th class="col-3">Projeto alvo</th>
                    <th class="col-1">Prob. on-time (%)</th>
                    <th class="col-1">Atraso (dias)</th>
                    <th class="col-1">Criticidade</th>
                </tr>
            </thead>
            <tbody>
                <tr class="d-flex dependency-row" id="dependency-row-template">
                    <td class="col-3"><input class="form-control" name="dependency_name" placeholder="Ex.: API Pagamentos" /></td>
                    <td class="col-3"><input class="form-control" name="dependency_source_project" placeholder="Projeto origem" /></td>
                    <td class="col-3"><input class="form-control" name="dependency_target_project" placeholder="Projeto bloqueado" /></td>
                    <td class="col-1"><input class="form-control" name="dep_probability" type="number" min="0" max="100" value="75" /></td>
                    <td class="col-1"><input class="form-control" name="dep_delay" type="number" min="0" value="10" /></td>
                    <td class="col-1">
                        <select class="form-control" name="dependency_criticality">
                            <option value="LOW">Baixa</option>
                            <option value="MEDIUM" selected>Média</option>
                            <option value="HIGH">Alta</option>
                            <option value="CRITICAL">Crítica</option>
                        </select>
                    </td>
                </tr>
                <tr class="d-flex" id="add-dependency-row">
                    <td class="col-12 text-right text-muted small">Clique em “Adicionar dependência” para incluir novas linhas.</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<div class="card-modern mb-4">
    <div class="d-flex align-items-center justify-content-between">
        <h4 class="mb-0">Resultados mais recentes</h4>
        <button type="button" class="btn btn-outline-modern btn-sm" id="loadLastSimulation"><i class="fas fa-cloud-download-alt mr-2"></i>Carregar da última simulação</button>
    </div>
    <p class="text-muted mt-2 mb-4">Os indicadores abaixo são derivados da última execução Monte Carlo que incluiu dependências.</p>

    <div id="dependencyTabResults" style="display: none;">
        <div class="metric-grid mb-4">
            <div class="metric-card">
                <div class="metric-label">Probabilidade de entregar no prazo</div>
                <div class="metric-value" id="dep-tab-on-time-prob">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Atraso esperado</div>
                <div class="metric-value" id="dep-tab-expected-delay">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Nível de risco</div>
                <div class="metric-value" id="dep-tab-risk-level">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Total de dependências</div>
                <div class="metric-value" id="dep-tab-total">-</div>
            </div>
        </div>

        <div class="card-modern">
            <h5 class="mb-3">Distribuição de atrasos</h5>
            <div class="table-responsive table-modern">
                <table class="table table-sm">
                    <thead>
                        <tr><th>Percentil</th><th>Atraso (dias)</th></tr>
                    </thead>
                    <tbody id="dep-tab-delay-body">
                        <tr><td colspan="2" class="text-muted">Sem dados de atraso disponíveis</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-modern">
            <h5 class="mb-3">Visualização</h5>
            <div id="dep-tab-visualization-container" class="bg-white p-3 rounded text-center">
                <p class="text-muted mb-0">Execute a simulação para gerar a visualização.</p>
                <img id="dep-tab-visualization-image" src="" alt="Heatmap de dependências" class="img-fluid d-none" />
            </div>
        </div>

        <div class="grid-columns-2">
            <div class="card-modern">
                <h5 class="mb-3"><i class="fas fa-exclamation-triangle mr-2"></i>Caminho crítico</h5>
                <ul id="dep-tab-critical-path" class="list-group"></ul>
            </div>
            <div class="card-modern">
                <h5 class="mb-3"><i class="fas fa-lightbulb mr-2"></i>Recomendações</h5>
                <ul id="dep-tab-recommendations" class="list-group"></ul>
            </div>
        </div>
    </div>

    <div id="dependencyTabEmpty" class="card-modern text-center">
        <div class="alert alert-warning mb-0">
            <h5 class="mb-2"><i class="fas fa-info-circle mr-2"></i>Nenhum resultado disponível</h5>
            <p class="mb-0">Execute a simulação Monte Carlo incluindo dependências para visualizar métricas.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/dependencies.js') }}?v=20241201"></script>
{% endblock %}
